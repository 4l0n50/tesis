%\input{bitstrings/proofasym-fig.tex}
\input{sections/bits/protocol.tex}

\subsection{Proof of Security}

Completeness is proven in Appendix \ref{proof:completeness}.
%\ref{proof:completeness}.
The following theorem guarantees Soundness. 
 
\begin{theorem} Let $\mathsf{Adv}_{\mathcal{PS}}(\advA)$ 
be the advantage of an adversary $\advA$ against the soundness of 
the proof system  described above. There exist PPT adversaries
$\advB_1,\advB_2,\advB_3,\advSound_1,\advSound_2$ such that 
\begin{eqnarray*}
\mathsf{Adv}_{\mathcal{PS}}(\advA) & \leq 
n& \left(6/q+ \mathsf{Adv}_{\mathcal{U}_1,\Gr}(\advB_1)
+  \mathsf{Adv}_{\mathcal{U}_1,\Hr}(\advB_2)
+  \mathsf{Adv}_{\SP_{\Hr}}(\advB_3)\right. \\
& & \mbox{ } 
+  \left.\mathsf{Adv}_{\QANIZKsum}(\advSound_1)
+
 \mathsf{Adv}_{\QANIZKcomms}(\advSound_2)\right).
\end{eqnarray*}
\label{teo:bitstr-soundness}
\end{theorem}

The proof follows from the indistinguishability of the following games:
\begin{itemize}
\item [$\mathsf{Real}$] This is the real soundness game. 
 The output is $1$ if  the adversary breaks the soundness,
i.e. the adversary submits
some $\hvecb{c} = \hmatr{U}\left(\begin{smallmatrix}\vecb{b}\\ w_g\end{smallmatrix}\right)$, for some
$\vecb{b}\notin \bits^n$ and $w \in \Z_q$, and
the corresponding proof which is accepted by the verifier.
\item[$\mathsf{Game}_0$] This game is identical to 
$\mathsf{Real}$ except that algorithm $\algK_1$ does not receive $\hmatr{U}$ as a input but it samples
$(\hmatr{U},\matr{U}) \in \mathcal{R}_{par}$
itself according to $\dist_{\Gamma}$.
\item[$\mathsf{Game}_1$] This game is identical to 
$\mathsf{Game_0}$ except that the simulator picks a random $i^* \in [n]$, and uses $\matr{U}$ to check  
    if the output of the adversary $\advA$ is such that 
    $b_{i^*}\in \bits$.  It aborts if  $b_{i^*}\in \bits$.
\item[$\mathsf{Game}_{2}$] This game is identical to 
$\mathsf{Game}_1$ except that now the vectors $[vecb{g}_{i}]_1$, $i \in [n]$ and $i \neq i^*$,
are uniform vectors in the space spanned by $[vecb{g}_{n+1}]_1$.   
\item[$\mathsf{Game}_{3}$] This game is identical to 
$\mathsf{Game}_2$ except that now the vector $[vecb{h}_{i^*}]_2$ is 
a uniform vector in $\Hr^2$, sampled independently of 
$[vecb{h}_{n+1}]_2$.     
\end{itemize}
It is obvious that the first two games are indistinguishable. 
The rest of the argument goes as follows (the remaining proofs are in Appendix \ref{proof:sound}). 

\begin{lemma} $\Pr\left[ \mathsf{Game}_1(\advA)=1\right]\geq\dfrac{1}{n}\Pr\left[\mathsf{Game}_0(\advA)=1\right].$
\label{lemma:bits1}
\end{lemma}

\begin{lemma} There exists a $\mathcal{U}_1$-$\mddh_{\Gr}$ adversary $\advB$ such that
$|\Pr\left[\mathsf{Game}_{1}(\advA)=1\right]$ $-\Pr\left[\mathsf{Game}_{2}(\advA)=1\right]|$ $\leq
    \mathsf{Adv}_{\mathcal{U}_1,\Gr}(\advB) + 2/q.$
\label{lemma:bits2}
\end{lemma}
\begin{proof}
The adversary $\advB$ receives $(\hvecb{s}, \hvecb{t})$ an instance of the $\mathcal{U}_1$-$\mddh_{\Gr}$ problem.
$\advB$ defines all the parameters honestly except that
it embeds the $\mathcal{U}_1$-$\mddh_{\Gr}$ challenge in the matrix 
$\Lck$.

Let $\hmatr{E}:=(\hvecb{s}||\hvecb{t})$. $\advB$ picks $i^*\gets[n]$, $\matr{W}_0\gets\Z_q^{2\times(i^*-1)}$,
$\matr{W}_1\gets\Z_q^{2\times(n-i^*)}$,
$[vecb{g}_{i^*}]_1\gets\Gr^{2}$,
and defines $\Lck := (\hmatr{E}\matr{W}_0||[vecb{g}_{i^*}]_1||\hmatr{E}\matr{W}_1|| \hvecb{s})$. 
In the real algorithm $\mathsf{K}_1$, the generator picks the matrix $\matr{\Delta} \in \Z_q^{2 \times (n+1)}$.
Although $\advB$ does not know $\matr{\Delta}$,  it can compute $\hmatr{\Delta}$ as $\hmatr{\Delta}= \Lck\matr{U}^{-1}$,
given that $\matr{U}$ is full rank and was  sampled 
by $\advB$, so it can compute the rest of the elements of the
common reference string  using the discrete logarithms of $\hmatr{U}$, $\Rck$ and $\cvecb{a}$.  

In case $\hvecb{t}$ is uniform over $\Gr^{2}$, by the Schwartz-Zippel lemma $\det(\hmatr{E}) = 0$ with probability at most $2/q$.
Thus, with probability at least $1-2/q$, the matrix $\hmatr{E}$ is full-rank and $\Lck$ is uniform over $\Gr^{2\times(n+1)}$ as in
$\sfGame_1$.
On the other hand, in case $\hat{\vecb{t}}=\gamma \hvecb{s}$, all of $[vecb{g}_{i}]_1$, $i\neq i^*$, are in the space
spanned by $[vecb{g}_{n+1}]_1$ as in $\sfGame_2$.
%
%In case $\hvecb{t}$ is uniform over $\Gr^{2}$, with overwhelming probability, the matrix $\hmatr{E}$ is full-rank and $\Lck$ is uniform over $\Gr^{2\times(n+1)}$ as in
%$\sfGame_1$.
%On the other hand, in case $\hat{\vecb{t}}=\gamma \hvecb{s}$, all of $[vecb{g}_{i}]_1$, $i\neq i^*$, are in the space
%spanned by $[vecb{g}_{n+1}]_1$ as in $\sfGame_2$.
\end{proof}

\begin{lemma} There exists a $\mathcal{U}_1$-$\mddh_{\Hr}$ adversary $\advB$ such that
$|\Pr\left[\mathsf{Game}_{2}(\advA)=1\right]$ $-\Pr\left[\mathsf{Game}_{3}(\advA)=1\right]|$ $\leq
\mathsf{Adv}_{\mathcal{U}_1,\Hr}(\advB).$
\label{lemma:bits3}
\end{lemma}

\begin{lemma} There exists a $\SP_{\Hr}$ adversary $\mathcal{\advB}$, a soundness adversary $\advSound_1$  for $\QANIZKsum$ and 
a strong soundness adversary $\advSound_2$ for $\QANIZKcomms$  such that
$$\Pr\left[\mathsf{Game}_3(\advA)=1\right] \leq 4/q + \adv_{\SP_{\Hr}}(\advB) +
\adv_\QANIZKsum(\advSound_1)+\adv_\QANIZKcomms(\advSound_2).$$  
\label{lemma:G3}
\end{lemma}
\begin{proof}
$\Pr[\det((\llck_{i^*}||\llck_{n+1}))=0]=\Pr[\det((\lrck_{i^*}||\lrck_{n+1}))=0]\leq2/q$, by the Schwartz-Zippel lemma. Then, with probability at least $1-4/q$, $\llck_{i^*}\lrck_{i^*}^\top$ is linearly independent from
$\{\llck_{i}\lrck_j^\top:(i,j)\in[n+1]^2\setminus\{(i^*, i^*)\}\}$ which implies that $\llck_{i^*}\lrck_{i^*}^\top\notin\Span(\{\matr{C}_{i,j}+\matr{D}_{i,j}:(i,j)\in\indexSet{n}{1}\})$. 
Additionally  $\sfGame_3(\advA)=1$ implies that $b_{i^*} \notin \{0,1\}$
while the verifier accepts the proof  produced by $\advA$, which is
$ (
        \hvecb{c}_{\Delta}, \cvecb{d},
        (\hmatr{\Theta}_{b(\overline{b}-1)}, \cmatr{\Pi}_{b(\overline{b}-1)}), 
        \{(\hat{\boldsymbol \rho}_{X}, \check{\boldsymbol \sigma}_{X})\}_{X \in \{b(\overline{b}-1), b-\overline{b}\}} ).$ Since $\{[vecb{h}_{i^*}]_2,[vecb{h}_{n+1}]_2\}$ is a basis of $\Hr^2$,
we can define $\overline{w}_h,\overline{b}_{i^*}$ as the unique coefficients in $\Z_q$ such that $\cvecb{d}= \overline{b}_{i^*} [vecb{h}_{i^*}]_2 + \overline{w}_h [vecb{h}_{n+1}]_2$.
We distinguish three cases:
\begin{itemize}
\item[1)] If $\hat{\vecb{c}}_{\Delta} \neq \matr{\Delta} \hat{\vecb{c}}$, we can construct an adversary 
$\advB$ against the $\SP_{\Hr}$ Assumption that outputs 
$\hat{\vecb{c}}_{\Delta}-\matr{\Delta} \hat{\vecb{c}}\in\ker(\cmatr{a}^\top)$.
\item[2)] If $\hat{\vecb{c}}_{\Delta} = \matr{\Delta} \hat{\vecb{c}}$ but $b_{i^*} \neq \overline{b}_{i^*}$. Given that $(b_{i}\llck_{i^*},\bar{b}_{i^*}\lrck_{i^*})$ is linearly independent from $\{(\llck_{i^*},\lrck_{i^*}),(\llck_{n+1},\lrck_{n+1})\}$
whenever $b_{i^*}\neq\bar{b}_{i^*}$, an adversary
$\advSound_2$ against the strong soundness of $\QANIZKcomms$
outputs the pair $(\hgrkb{\rho}_{b-\overline{b}},
\cgrkb{\sigma}_{b-\overline{b}})
$ which is a fake proof for 
$(\hvecb{c}_\Delta,\cvecb{d})$. Note that strong soundness is required since, in order to compute $\{\hmatr{C}_{i,j},\cmatr{D}_{i,j}:(i,j)\in\indexSet{n}{1}\}$, $\advSound_2$ requires the discrete logs of either $\hmatr{G}$ or $\cmatr{D}$.
\item[3)] If $\hat{\vecb{c}}_{\Delta} = \matr{\Delta} \hat{\vecb{c}}$ and $b_{i^*} = \overline{b}_{i^*}$, then 
$b_{i^*}(\overline{b}_{i^*} -1) \neq 0$.
If we express $\matr{\Theta}_{b(\overline{b}-1)}+\matr{\Pi}_{b(\overline{b}-1)}$
as a linear combination of $\llck_{i}\lrck_{j}^{\top}$, the coordinate of
$\llck_{i^*}\lrck_{i^*}^\top$ is $b_{i^*}(\overline{b}_{i^*}-1)\neq 0$ and thus $\matr{\Theta}_{b(\overline{b}-1)}+\matr{\Pi}_{b(\overline{b}-1)}\notin\Span(\{\matr{C}_{i,j}+\matr{D}_{i,j}:(i,j)\in\indexSet{n}{1}\})$.
The adversary $\advSound_1$ against $\QANIZKsum$  outputs the pair
$(\hgrkb{\rho}_{b(\overline{b}-1)},$ $\cgrkb{\sigma}_{b(\overline{b}-1)})$
which is a fake proof for $(\hmatr{\Theta}_{b(\overline{b}-1)}, \cmatr{\Pi}_{b(\overline{b}-1)})$. \footnote{The proof system $\spsmas$ is constructed for matrices $\{(\matr{C}_{i,j},\matr{D}_{i,j}):(i,j)\in\indexSet{n}{1}\}$ sampled from some distribution $\dist_{\Gamma}$, which in this case depends on the distribution of $\matr{G}$ and $\matr{H}$. We assume that the adversary $\advSound_2$ against $\spsmas$ receives the common reference string of $\spsmas$ as described in Section \ref{sec:QANIZKsum} and additionally the matrices $\hmatr{G}$ and $\cmatr{H}$ which defines the language, i.e. the distribution of $\matr{C}_{i,j}$, $\matr{D}_{i,j}$ (this is necessary so that $\advSound_2$ can simulate the crs for adversary $\advA$). We stress this additional information to describe the language does not affect the soundness proof for Theorem \ref{theo:membtwogroups1} (in particular,  $\hmatr{G}$ and $\cmatr{H}$ are independent of $(\matr{\Lambda}, \matr{\Xi})$).}
\end{itemize}
\end{proof}

This concludes the proof of soundness. Now we prove Zero-Knowledge.

\begin{theorem}
The proof system is perfect quasi-adaptive zero-knowledge.
\end{theorem} 
\begin{proof}  First, note that the vector $\vd \in \Hr^2$ output by the prover and the vector output by $\mathsf{S}_2$ follow exactly the same distribution. This is because the rank of $\Rck$ is $1$. In particular, although the simulator $\mathsf{S}_2$ does not know the opening of $\hvecb{c}$, which is some $\vecb{b} \in \{0,1\}^{n}$, 
there exists $w_h \in \Z_q$ such that $\vd=\Rck\smallpmatrix{\vecb{b}\\ w_h}$. 
Since $\matr{R}$ is chosen uniformly at random in $\Z_q^{2 \times 2}$, the proof $(\hmatr{\Theta}_{b(\overline{b}-1)}, \cmatr{\Pi}_{b(\overline{b}-1)})$ is uniformly distributed conditioned on satisfying check 2) of algorithm $\algV$.
Therefore, these elements of the simulated proof have the same distribution as in a real proof. This fact combined with the perfect zero-knowledge property of $\QANIZKsum$  and $\QANIZKcomms$ concludes the proof. 
\end{proof}


