%\input{bitstrings/proofasym-fig.tex}
\input{sections/bits/protocol.tex}

\subsection{Proof of Security}

\begin{theorem}
The proof system from Sect. \ref{bits-proof-system} is QA-NIZK proof system for the language $\Lang_{ck,\sfbits}$ with perfect completeness, computational soundness, and perfect zero-knowledge
\end{theorem}

\begin{proof}
(Completeness.) It is obvious by definition that for any $[\vecb{c}]_1\in \Lang_{ck,\sfbits}$
the vector $[\vecb{c}_\Delta]_1$
generated by an honest prover passes the verification test described in 1).

Note that,
by definition of $[\matr{C}_{i,j}]_1$ and $[\matr{D}_{i,j}]_2$, 
$[\matr{C}_{i,j}]_1[\matr{I}_{2\times2}]_2 + [\matr{I}_{2\times2}]_1 [\matr{D}_{i,j}]_2
= [\vecb{g}_{i}]_1[\vecb{h}_j^\top]_2$.  Since $b_i(b_i-1) = 0$ for each $i\in[n]$,
\begin{align*}
&[\vecb{c}_{\Delta}]_1 \left( [\vecb{d}]_2 - \sum_{i\in[n]} [\vecb{h}_{i}]_2 \right)^\top \\
  =& 
    \sum_{i \in [n]}\left(
        b_i w_h[\vecb{g}_{i}]_1[\vecb{h}_{n+1}^{\top}]_2 +w_g(b_i-1) [\vecb{g}_{n+1}]_1[\vecb{h}_i^{\top}]_2 +
        \sum_{j \in [n]} b_i (b_j-1) [\vecb{g}_{i}]_1[\vecb{h}_{j}^{\top}]_2
    \right) +\\
&
    w_gw_h [\vecb{g}_{n+1}][\vecb{h}_{n+1}^{\top}]_2
\\  = & 
    \sum_{i \in [n]}\left(
        b_i w_h[\vecb{g}_{i}]_1[\vecb{h}_{n+1}^\top]_2 +
        w_g(b_i-1) [\vecb{g}_{n+1}]_1[\vecb{h}_{i}^\top]_2 +
        \sum_{\substack{j \in [n]\\ j\neq i}} b_i (b_j-1) [\vecb{g}_{i}]_1[\vecb{h}_{j}^\top]_2
    \right)
\\  &
    + w_gw_h [\vecb{g}_{n+1}]_1[\vecb{h}_{n+1}^\top]_2 +
    [\matr{R}]_1[\matr{I}_{2\times2}]_2 - [\matr{I}_{2\times2}]_1[\matr{R}]_2
\\  = &
    [\matr{\Theta}]_1[\matr{I}_{2\times2}]_2 +
    [\matr{I}_{2\times2}]_1[\matr{\Pi}]_2.
\end{align*}
Finally, the rest of the proof follows from completeness of ${\Psi_\sfcom}$ and ${\Psi_\sfsum}$. 

(Soundness.) Soundness is proven in Theorem \ref{teo:bitstr-soundness}.

(Zero-Knowledge.) First, note that the vector $[\vecb{d}]_2 \in \Hr^2$ output by the prover and the vector output by $\mathsf{S}_2$ follow exactly the same distribution. This is because the rank of $\Rck$ is $1$. In particular, although the simulator $\mathsf{S}_2$ does not know the opening of $[\vecb{c}]_1$, which is some $\vecb{b} \in \{0,1\}^{n}$, 
there exists $w_h \in \Z_q$ such that $[\vecb{d}]_2=\Rck\smallpmatrix{\vecb{b}\\ w_h}$. 
Since $\matr{R}$ is chosen uniformly at random in $\Z_q^{2 \times 2}$, the proof $([\matr{\Theta}]_1, [\matr{\Pi}]_2)$ is uniformly distributed conditioned on satisfying check 2) of algorithm $\algV$.
Therefore, these elements of the simulated proof have the same distribution as in a real proof. This fact combined with the perfect zero-knowledge property of ${\Psi_\sfsum}$  and ${\Psi_\sfcom}$ concludes the proof. 
\end{proof}

The following theorem guarantees Soundness. 
 
\begin{theorem} Let $\mathsf{Adv}_{\mathcal{PS}}(\advA)$ 
be the advantage of an adversary $\advA$ against the soundness of 
the proof system  described above. There exist PPT adversaries
$\advB_1,\advB_2,\advB_3,\advSound_1,\advSound_2$ such that 
\begin{eqnarray*}
\mathsf{Adv}_{\mathcal{PS}}(\advA) & \leq 
n& \left(6/q+ \mathsf{Adv}_{\mathcal{U}_1,\Gr}(\advB_1)
+  \mathsf{Adv}_{\mathcal{U}_1,\Hr}(\advB_2)
+  \mathsf{Adv}_{\SP_{\Hr}}(\advB_3)\right. \\
& & \mbox{ } 
+  \left.\mathsf{Adv}_{{\Psi_\sfsum}}(\advSound_1)
+
 \mathsf{Adv}_{{\Psi_\sfcom}}(\advSound_2)\right).
\end{eqnarray*}
\label{teo:bitstr-soundness}
\end{theorem}

The proof follows from the indistinguishability of the following games:
\begin{itemize}
\item [$\mathsf{Real}$] This is the real soundness game. 
 The output is $1$ if  the adversary breaks the soundness,
i.e. the adversary submits
some $[\vecb{c}]_1 = [\matr{U}]_1\left(\begin{smallmatrix}\vecb{b}\\ w_g\end{smallmatrix}\right)$, for some
$\vecb{b}\notin \bits^n$ and $w \in \Z_q$, and
the corresponding proof which is accepted by the verifier.
\item[$\mathsf{Game}_0$] This game is identical to 
$\mathsf{Real}$ except that algorithm $\algK_1$ does not receive $[\matr{U}]_1$ as a input but it samples
$([\matr{U}]_1,\matr{U}) \in \mathcal{R}_{par}$
itself according to $\dist_{{gk}}$.
\item[$\mathsf{Game}_1$] This game is identical to 
$\mathsf{Game_0}$ except that the simulator picks a random $i^* \in [n]$, and uses $\matr{U}$ to check  
    if the output of the adversary $\advA$ is such that 
    $b_{i^*}\in \bits$.  It aborts if  $b_{i^*}\in \bits$.
\item[$\mathsf{Game}_{2}$] This game is identical to 
$\mathsf{Game}_1$ except that now the vectors $[\vecb{g}_{i}]_1$, $i \in [n]$ and $i \neq i^*$,
are uniform vectors in the space spanned by $[\vecb{g}_{n+1}]_1$.   
\item[$\mathsf{Game}_{3}$] This game is identical to 
$\mathsf{Game}_2$ except that now the vector $[\vecb{h}_{i^*}]_2$ is 
a uniform vector in $\Hr^2$, sampled independently of 
$[\vecb{h}_{n+1}]_2$.     
\end{itemize}
It is obvious that the first two games are indistinguishable. 
The rest of the argument goes as follows. 

\begin{lemma} $\Pr\left[ \mathsf{Game}_1(\advA)=1\right]\geq\dfrac{1}{n}\Pr\left[\mathsf{Game}_0(\advA)=1\right].$
\label{lemma:bits1}
\end{lemma}

\begin{proof}  The probability that
 $\mathsf{Game}_1(\advA)=1$ is the probability that  a) $\mathsf{Game}_0(\advA)=1$ and
b)  $b_{i^*} \notin \bits$. The view of adversary $\advA$ is independent of $i^*$, while, if $\mathsf{Game_0}(\advA)=1$, then there is at least one index $\ell \in [n]$ such that  
such that  $b_{\ell} \notin \bits$. Thus, 
the probability that the event described in b) occurs conditioned on $\mathsf{Game_0}(\advA)=1$, is greater than or equal to $1/n$ and the lemma follows.
\end{proof}

\begin{lemma} There exists a~$\mathcal{U}_1$-$\mddh_{\Gr}$ adversary $\advB$ such that
$|\Pr\left[\mathsf{Game}_{1}(\advA)=1\right]$ $-\Pr\left[\mathsf{Game}_{2}(\advA)=1\right]|$ $\leq
    \mathsf{Adv}_{\mathcal{U}_1,\Gr}(\advB) + 2/q.$
\label{lemma:bits2}
\end{lemma}
\begin{proof}
The adversary $\advB$ receives $([\vecb{s}]_1, [\vecb{t}]_1)$ an instance of the $\mathcal{U}_1$-$\mddh_{\Gr}$ problem.
$\advB$ defines all the parameters honestly except that
it embeds the $\mathcal{U}_1$-$\mddh_{\Gr}$ challenge in the matrix 
$\Lck$.

Let $[\matr{E}]_1:=([\vecb{s}]_1||[\vecb{t}]_1)$. $\advB$ picks $i^*\gets[n]$, $\matr{W}_0\gets\Z_q^{2\times(i^*-1)}$,
$\matr{W}_1\gets\Z_q^{2\times(n-i^*)}$,
$[\vecb{g}_{i^*}]_1\gets\Gr^{2}$,
and defines $\Lck := ([\matr{E}]_1\matr{W}_0||[\vecb{g}_{i^*}]_1||[\matr{E}]_1\matr{W}_1|| [\vecb{s}]_1)$. 
In the real algorithm $\mathsf{K}_1$, the generator picks the matrix $\matr{\Delta} \in \Z_q^{2 \times (n+1)}$.
Although $\advB$ does not know $\matr{\Delta}$,  it can compute $[\matr{\Delta}]_1$ as $[\matr{\Delta}]_1= \Lck\matr{U}^{-1}$,
given that $\matr{U}$ is full rank and was  sampled 
by $\advB$, so it can compute the rest of the elements of the
common reference string  using the discrete logarithms of $[\matr{U}]_1$, $\Rck$ and $[\vecb{a}]_2$.  

In case $[\vecb{t}]_1$ is uniform over $\Gr^{2}$, by the Schwartz-Zippel lemma $\det([\matr{E}]_1) = 0$ with probability at most $2/q$.
Thus, with probability at least $1-2/q$, the matrix $[\matr{E}]_1$ is full-rank and $\Lck$ is uniform over $\Gr^{2\times(n+1)}$ as in
$\sfGame_1$.
On the other hand, in case $[\vecb{t}]_1=\gamma [\vecb{s}]_1$, all of $[\vecb{g}_{i}]_1$, $i\neq i^*$, are in the space
spanned by $[\vecb{g}_{n+1}]_1$ as in $\sfGame_2$.
\end{proof}

\begin{lemma} There exists a $\mathcal{U}_1$-$\mddh_{\Hr}$ adversary $\advB$ such that
$|\Pr\left[\mathsf{Game}_{2}(\advA)=1\right]$ $-\Pr\left[\mathsf{Game}_{3}(\advA)=1\right]|$ $\leq
\mathsf{Adv}_{\mathcal{U}_1,\Hr}(\advB).$
\label{lemma:bits3}
\end{lemma}

\begin{proof}
The adversary $\advB$ receives an instance of the $\mathcal{U}_1$-$\mddh_{\GG_2}$ problem, which is a pair
$([\vecb{s}]_2, [\vecb{t}]_2)$, where $[\vecb{s}]_2$ is a uniform vector 
of $\Hr^{2}$ and $[\vecb{t}]_2$ is either a uniform vector in $\Hr^2$ or 
$[\vecb{t}]_2=\gamma[\vecb{s}]_2$, for random $\gamma\in\Z_q$.      
 
Adversary $\advB$ defines 
$[\vecb{h}_{n+1}]_2:= [\vecb{s}]_2$ and the rest of the columns of $\Rck$ are honestly sampled
with the sole exception of $[\vecb{h}_{i^*}]_2$, which is set to $[\vecb{t}]_2$.

Given that adversary $\advB$ can only compute $\llck_{i}[\vecb{h}_j^\top]_2\in\Hr^{2\times2}$,
it defines $[\matr{D}_{i,j}]_2 := \llck_{i}[\vecb{h}_j^\top]_2 - [\matr{T}_{i,j}]_2$ and
$[\matr{C}_{i,j}]_1:=[\matr{T}_{i,j}]_1$, for $\matr{T}_{i,j}\gets\Z_q^{2\times 2}$ and $(i,j)\in\indexSet{n}{1}$. Note 
that this does not change the distribution of $([\matr{D}_{i,j}]_2,[\matr{C}_{i,j}]_1)$, which is the uniform one conditioned
on $\matr{C}_{i,j}+\matr{D}_{i,j}= \llck_i\lrck_j^\top.$

The rest of the parameters are computed using $\vecb{a}\gets\distlin_1$,
the matrix $\matr{\Delta} \in \Z_q^{2 \times (n+1)}$ and the discrete logarithms
of $\Lck$.
It is immediate to see that adversary $\advB$ perfectly simulates $\sfGame_2$ when $[\vecb{t}]_2=\gamma[\vecb{s}]_2$ and $\sfGame_3$ when $[\vecb{t}]_2$ is uniform.  
\end{proof}

\begin{lemma} There exists a $\SP_{\Hr}$ adversary $\mathcal{\advB}$, a soundness adversary $\advSound_1$  for ${\Psi_\sfsum}$ and 
a strong soundness adversary $\advSound_2$ for ${\Psi_\sfcom}$  such that
$$\Pr\left[\mathsf{Game}_3(\advA)=1\right] \leq 4/q + \adv_{\SP_{\Hr}}(\advB) +
\adv_{\Psi_\sfsum}(\advSound_1)+\adv_{\Psi_\sfcom}(\advSound_2).$$  
\label{lemma:G3}
\end{lemma}
\begin{proof}
$\Pr[\det((\llck_{i^*}||\llck_{n+1}))=0]=\Pr[\det((\lrck_{i^*}||\lrck_{n+1}))=0]\leq2/q$, by the Schwartz-Zippel lemma. Then, with probability at least $1-4/q$, $\llck_{i^*}\lrck_{i^*}^\top$ is linearly independent from
$\{\llck_{i}\lrck_j^\top:(i,j)\in[n+1]^2\setminus\{(i^*, i^*)\}\}$ which implies that $\llck_{i^*}\lrck_{i^*}^\top\notin\Span(\{\matr{C}_{i,j}+\matr{D}_{i,j}:(i,j)\in\indexSet{n}{1}\})$. 
Additionally  $\sfGame_3(\advA)=1$ implies that $b_{i^*} \notin \{0,1\}$
while the verifier accepts the proof  produced by $\advA$, which is
$ (
        [\vecb{c}_{\Delta}]_1, [\vecb{d}]_2,
        ([\matr{\Theta}]_1, [\matr{\Pi}]_2), 
        \pi_\sfsum,\pi_\sfcom
).$ Since $\{[\vecb{h}_{i^*}]_2,[\vecb{h}_{n+1}]_2\}$ is a basis of $\Hr^2$,
we can define $\overline{w}_h,\overline{b}_{i^*}$ as the unique coefficients in $\Z_q$ such that $[\vecb{d}]_2= \overline{b}_{i^*} [\vecb{h}_{i^*}]_2 + \overline{w}_h [\vecb{h}_{n+1}]_2$.
We distinguish three cases:
\begin{itemize}
\item[1)] If $[\vecb{c}_{\Delta}]_1 \neq \matr{\Delta} [\vecb{c}]_1$, we can construct an adversary 
$\advB$ against the $\SP_{\Hr}$ Assumption that outputs 
$[\vecb{c}_{\Delta}]_1-\matr{\Delta} [\vecb{c}]_1\in\ker([\matr{a}]_2^\top)$.
\item[2)] If $[\vecb{c}_{\Delta}]_1 = \matr{\Delta} [\vecb{c}]_1$ but $b_{i^*} \neq \overline{b}_{i^*}$. Given that $[\vecb{c}]_1$ is perfectly binding and that $\bb_{i^*}\neq b_{i^*}$ is the unique opening of $[\vecb{c}_\Delta]_1$ at coordinate $i^*$, both commitments can not be opened to the same value. Therefore, the adversary $\advSound_2$ against the strong soundness of ${\Psi_\sfcom}$
outputs $\pi_\sfcom$ which is a fake proof for 
$([\vecb{c}_\Delta]_1,[\vecb{d}]_2)$. Note that strong soundness is required since, in order to compute $\{[\matr{C}_{i,j}]_1,[\matr{D}_{i,j}]_2:(i,j)\in\indexSet{n}{1}\}$, $\advSound_2$ requires the discrete logs of either $[\matr{G}]_1$ or $[\matr{D}]_2$.
\item[3)] If $[\vecb{c}_{\Delta}]_1 = \matr{\Delta} [\vecb{c}]_1$ and $b_{i^*} = \overline{b}_{i^*}$, then 
$b_{i^*}(\overline{b}_{i^*} -1) \neq 0$.
If we express $\matr{\Theta}+\matr{\Pi}$
as a linear combination of $\llck_{i}\lrck_{j}^{\top}$, the coordinate of
$\llck_{i^*}\lrck_{i^*}^\top$ is $b_{i^*}(\overline{b}_{i^*}-1)\neq 0$ and thus $\matr{\Theta}+\matr{\Pi}\notin\Span(\{\matr{C}_{i,j}+\matr{D}_{i,j}:(i,j)\in\indexSet{n}{1}\})$.
The adversary $\advSound_1$ against ${\Psi_\sfsum}$  outputs  $\pi_\sfsum$
which is a fake proof for $([\matr{\Theta}]_1, [\matr{\Pi}]_2)$. \footnote{The proof system $\Psi_\sfsum$ is constructed for matrices $\{(\matr{C}_{i,j},\matr{D}_{i,j}):(i,j)\in\indexSet{n}{1}\}$ sampled from some distribution $\dist_{{gk}}$, which in this case depends on the distribution of $\matr{G}$ and $\matr{H}$. We assume that the adversary $\advSound_2$ against $\Psi_\sfsum$ receives the common reference string of $\Psi_\sfsum$ as described in Section \ref{sec:sum} and additionally the matrices $[\matr{G}]_1$ and $[\matr{H}]_2$ which defines the language, i.e. the distribution of $\matr{C}_{i,j}$, $\matr{D}_{i,j}$ (this is necessary so that $\advSound_2$ can simulate the crs for adversary $\advA$). We stress this additional information to describe the language does not affect the soundness proof for Theorem \ref{theo:membtwogroups1} (in particular,  $[\matr{G}]_1$ and $[\matr{H}]_2$ are independent of $(\matr{\Lambda}, \matr{\Xi})$).}
\end{itemize}
\end{proof}
